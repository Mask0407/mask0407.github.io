<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" >

<title>SpringCloud之Ribbon-负载均衡 | 个人博客</title>

<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.12.0/css/all.min.css">
<link rel="shortcut icon" href="https://mask0407.github.io/favicon.ico?v=1593400819751">
<link rel="stylesheet" href="https://mask0407.github.io/styles/main.css">





<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.css" />
<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>



    <meta name="description" content="负载均衡:Spring Cloud Ribbon
Spring Cloud Ribbon 是一个基于Http和TCP的客服端负载均衡工具，它是基于Netflix Ribbon实现的。通过SpringCloud的自动配置使得项目可以自动的给R..." />
    <meta name="keywords" content="SpringCloud,微服务" />
  </head>
  <body>
    <div id="app" class="main">

      <div class="sidebar" :class="{ 'full-height': menuVisible }">
  <div class="top-container" data-aos="fade-right">
    <div class="top-header-container">
      <a class="site-title-container" href="https://mask0407.github.io">
        <img src="https://mask0407.github.io/images/avatar.png?v=1593400819751" class="site-logo">
        <h1 class="site-title">个人博客</h1>
      </a>
      <div class="menu-btn" @click="menuVisible = !menuVisible">
        <div class="line"></div>
      </div>
    </div>
    <div>
      
        
          <a href="/" class="site-nav">
            首页
          </a>
        
      
        
          <a href="/archives" class="site-nav">
            归档
          </a>
        
      
        
          <a href="/tags" class="site-nav">
            标签
          </a>
        
      
        
          <a href="/post/about" class="site-nav">
            关于
          </a>
        
      
    </div>
  </div>
  <div class="bottom-container" data-aos="flip-up" data-aos-offset="0">
    <div class="social-container">
      
        
      
        
      
        
      
        
      
        
      
        
      
    </div>
    <div class="site-description">
      温故而知新
    </div>
    <div class="site-footer">
      Powered by <a href="https://github.com/getgridea/gridea" target="_blank">Gridea</a> | <a class="rss" href="https://mask0407.github.io/atom.xml" target="_blank">RSS</a>
    </div>
  </div>
</div>


      <div class="main-container">
        <div class="content-container" data-aos="fade-up">
          <div class="post-detail">
            <h2 class="post-title">SpringCloud之Ribbon-负载均衡</h2>
            <div class="post-date">2020-06-29</div>
            
            <div class="post-content" v-pre>
              <h2 id="负载均衡spring-cloud-ribbon">负载均衡:Spring Cloud Ribbon</h2>
<p>Spring Cloud Ribbon 是一个基于Http和TCP的客服端负载均衡工具，它是基于Netflix Ribbon实现的。通过SpringCloud的自动配置使得项目可以自动的给RestTemplate添加拦截器，实现负载均衡的作用。</p>
<h2 id="快速入门">快速入门</h2>
<ul>
<li>pom.xml</li>
</ul>
<pre><code class="language-xml">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot;
         xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;
         xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt;
  &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;

  &lt;groupId&gt;com.mask&lt;/groupId&gt;
  &lt;artifactId&gt;cloud&lt;/artifactId&gt;
  &lt;version&gt;1.0-SNAPSHOT&lt;/version&gt;

  &lt;properties&gt;
    &lt;project.build.sourceEncoding&gt;UTF-8&lt;/project.build.sourceEncoding&gt;
    &lt;java.version&gt;1.8&lt;/java.version&gt;
  &lt;/properties&gt;


  &lt;parent&gt;
    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
    &lt;artifactId&gt;spring-boot-starter-parent&lt;/artifactId&gt;
    &lt;version&gt;2.1.5.RELEASE&lt;/version&gt;
  &lt;/parent&gt;

  &lt;dependencyManagement&gt;
    &lt;dependencies&gt;
      &lt;dependency&gt;
        &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
        &lt;artifactId&gt;spring-cloud-dependencies&lt;/artifactId&gt;
        &lt;version&gt;Greenwich.SR1&lt;/version&gt;
        &lt;type&gt;pom&lt;/type&gt;
        &lt;scope&gt;import&lt;/scope&gt;
      &lt;/dependency&gt;
    &lt;/dependencies&gt;
  &lt;/dependencyManagement&gt;

  &lt;dependencies&gt;

    &lt;dependency&gt;
      &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
      &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;
    &lt;/dependency&gt;

    &lt;dependency&gt;
      &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
      &lt;artifactId&gt;spring-cloud-starter-netflix-ribbon&lt;/artifactId&gt;
    &lt;/dependency&gt;

    &lt;dependency&gt;
      &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
      &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt;
      &lt;scope&gt;test&lt;/scope&gt;
    &lt;/dependency&gt;

  &lt;/dependencies&gt;
&lt;/project&gt;
</code></pre>
<ul>
<li>application.properties</li>
</ul>
<pre><code class="language-properties">server.port=8080
#server.port=8088
USER-SERVICE.ribbon.listOfServers=localhost:8080,localhost:8088
USER-SERVICE.ribbon.NFLoadBalancerRuleClassName=com.netflix.loadbalancer.RandomRule
</code></pre>
<ul>
<li>UserController</li>
</ul>
<pre><code class="language-java">@RestController
@RequestMapping(&quot;manager&quot;)
public class UserController {
	@RequestMapping(value=&quot;user/{id}&quot;,method = {RequestMethod.GET})
	public User queyUserById(@PathVariable(value = &quot;id&quot;) Integer id){
		System.out.println(&quot;-------getUser--------&quot;);
		return new User(&quot;张三&quot;, new Date(), true, 12345.00);
	}

	@RequestMapping(value=&quot;user&quot;,method = {RequestMethod.POST})
	public User saveUser(@RequestBody User user){
		System.out.println(&quot;-------saveUser--------&quot;);
		return user;
	}

	@RequestMapping(value=&quot;user&quot;,method = {RequestMethod.PUT})
	public void update(@RequestBody User user){
		System.out.println(&quot;-------updateUser--------&quot;);
	}

	@RequestMapping(value=&quot;user/{pageNow}/{pageSize}&quot;,method = {RequestMethod.GET})
	public List&lt;User&gt; queyUserByPage(@PathVariable(value = &quot;pageNow&quot;) Integer pageNow,
									 @PathVariable(value = &quot;pageSize&quot;) Integer pageSize){
		List&lt;User&gt; list = new ArrayList&lt;&gt;();
		list.add(new User(&quot;张三&quot;, new Date(), false, 11111.00));
		list.add(new User(&quot;李四&quot;, new Date(), true, 20000.00));
		System.out.println(&quot;-------getUserPage--------&quot;);
		return list;
	}

	@RequestMapping(value=&quot;user/{ids}&quot;,method = {RequestMethod.DELETE})
	public void deleteUserById(@PathVariable(value = &quot;ids&quot;) Integer[] ids){
		System.out.println(&quot;-------deleteUsers--------&quot;);
	}
}
</code></pre>
<ul>
<li>SpringRibbonApplication</li>
</ul>
<pre><code class="language-java">@SpringBootApplication
public class SpringRibbonApplication {
    public static void main(String[] args) {
        SpringApplication.run(SpringRibbonApplication.class,args);
    }
    @Bean
    @LoadBalanced
    public RestTemplate restTemplate(){
        return new RestTemplate();
    }
}
</code></pre>
<ul>
<li>User</li>
</ul>
<pre><code class="language-java">public class User implements Serializable {
    private Integer id;
    private String name;
    @DateTimeFormat(pattern = &quot;yyyy-MM-dd HH:mm:ss&quot;)
    @JsonFormat(pattern = &quot;yyyy-MM-dd HH:mm:ss&quot;)
    private Date birthDay;
    private Boolean sex;
    private Double salary;
}
</code></pre>
<ul>
<li>RestTemplateTests</li>
</ul>
<pre><code class="language-java">@SpringBootTest(classes = SpringRibbonApplication.class)
@RunWith(SpringRunner.class)
public class RestTemplateTests {
	@Autowired
	private RestTemplate restTemplate;
	@Test
	public void testQueryUserById(){
		String url=&quot;http://USER-SERVICE/manager/user/1&quot;;
		User user = restTemplate.getForObject(url, User.class);
		System.out.println(user);
	}
	@Test
	public void testQueryUserByPage(){
		String url=&quot;http://USER-SERVICE/manager/user/1/10&quot;;
		List&lt;User&gt; users = restTemplate.getForObject(url, List.class);
		for (int i = 0; i &lt; users.size(); i++) {
			System.out.println(users.get(i));
		}
	}
	@Test
	public void testSaveUser(){
		String url=&quot;http://USER-SERVICE/manager/user&quot;;
		User user = restTemplate.postForObject(url, new User(&quot;李四&quot;, new Date(), true, 15000.0), User.class);
		System.out.println(user);
	}
	@Test
	public void testUpdateUser(){
		String url=&quot;http://USER-SERVICE/manager/user&quot;;
		User user = new User(&quot;李四&quot;, new Date(), true, 18000.0);
		user.setId(3);
		restTemplate.put(url,user);
	}
	@Test
	public void testDeleteUser(){
		String url=&quot;http://USER-SERVICE/manager/user/1,2,3&quot;;
		restTemplate.delete(url);
	}
}
</code></pre>
<p>除此自外，SpringCloud提供了一种基于配置文件的配置方式</p>
<ul>
<li>SpringRibbonApplication</li>
</ul>
<pre><code class="language-java">@SpringBootApplication
@RibbonClient(name = &quot;USER-SERVICE&quot;,configuration = {UserSerivceRibbonConfigure.class})
public class SpringRibbonApplication {
    public static void main(String[] args) {
        SpringApplication.run(SpringRibbonApplication.class,args);
    }
    @Bean
    @LoadBalanced
    public RestTemplate restTemplate(){
        return new RestTemplate();
    }
}
</code></pre>
<ul>
<li>UserSerivceRibbonConfigure</li>
</ul>
<pre><code class="language-java">@Configuration
public class UserSerivceRibbonConfigure {
    @Bean
    public ServerList&lt;Server&gt; ribbonServerList(){
        Server server1 = new Server(&quot;localhost&quot;, 8080);
        server1.setZone(&quot;beijing&quot;);

        Server server2 = new Server(&quot;localhost&quot;, 9090);
        server2.setZone(&quot;shanghai&quot;);
        return new StaticServerList&lt;Server&gt;(server1,server2);
    }

    @Bean
    public IRule ribbonRule(){
        return new RandomRule();
    }
    @Bean
    public ZonePreferenceServerListFilter ribbonServerListFilter(){
        ZonePreferenceServerListFilter filter = new ZonePreferenceServerListFilter();
        filter.setZone(&quot;beijing&quot;);
        return filter;
    }
}
</code></pre>
<p>用户可以直接使用LoadBalancerClient查询服务列表</p>
<pre><code class="language-java">@Autowired
private LoadBalancerClient loadBalancer;

@Test
public void testChoose(){
  for (Integer i=0;i&lt;10;i++){
    ServiceInstance instance = loadBalancer.choose(&quot;stores&quot;);
    URI storesUri = URI.create(String.format(&quot;http://%s:%s&quot;, instance.getHost(), instance.getPort()));
    System.out.println(storesUri);
  }
}
</code></pre>
<p>测试结果<br>
<img src="https://img-blog.csdnimg.cn/20200212152220673.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L00yODM1OTIzMzg=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述" loading="lazy"><br>
<img src="https://img-blog.csdnimg.cn/20200212152253747.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L00yODM1OTIzMzg=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述" loading="lazy"></p>

            </div>
            
              <div class="tag-container">
                
                  <a href="https://mask0407.github.io/uyhs3Xoe6/" class="tag">
                    SpringCloud
                  </a>
                
                  <a href="https://mask0407.github.io/rg_9e-j4YM/" class="tag">
                    微服务
                  </a>
                
              </div>
            
            
              <div class="next-post">
                <div class="next">下一篇</div>
                <a href="https://mask0407.github.io/elasticsearch00/">
                  <h3 class="post-title">
                    Elasticsearch入门篇
                  </h3>
                </a>
              </div>
            

            

          </div>

        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.min.js"></script>
<script type="application/javascript">

AOS.init();

var app = new Vue({
  el: '#app',
  data: {
    menuVisible: false,
  },
})

</script>






  </body>
</html>
