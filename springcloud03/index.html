<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" >

<title>SpringCloud之服务注册-Eureka | 个人博客</title>

<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.12.0/css/all.min.css">
<link rel="shortcut icon" href="https://mask0407.github.io/favicon.ico?v=1593400910740">
<link rel="stylesheet" href="https://mask0407.github.io/styles/main.css">





<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.css" />
<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>



    <meta name="description" content="Spring Cloud Eureka 是 Spring Cloud Netflix 微服务套件中的一部分， 它基于 Netflix Eureka 做了二次封装， 主要负责完成微服务架构中的服务治理功能。 Spring Cloud 通过为E..." />
    <meta name="keywords" content="SpringCloud,微服务" />
  </head>
  <body>
    <div id="app" class="main">

      <div class="sidebar" :class="{ 'full-height': menuVisible }">
  <div class="top-container" data-aos="fade-right">
    <div class="top-header-container">
      <a class="site-title-container" href="https://mask0407.github.io">
        <img src="https://mask0407.github.io/images/avatar.png?v=1593400910740" class="site-logo">
        <h1 class="site-title">个人博客</h1>
      </a>
      <div class="menu-btn" @click="menuVisible = !menuVisible">
        <div class="line"></div>
      </div>
    </div>
    <div>
      
        
          <a href="/" class="site-nav">
            首页
          </a>
        
      
        
          <a href="/archives" class="site-nav">
            归档
          </a>
        
      
        
          <a href="/tags" class="site-nav">
            标签
          </a>
        
      
        
          <a href="/post/about" class="site-nav">
            关于
          </a>
        
      
    </div>
  </div>
  <div class="bottom-container" data-aos="flip-up" data-aos-offset="0">
    <div class="social-container">
      
        
      
        
      
        
      
        
      
        
      
        
      
    </div>
    <div class="site-description">
      温故而知新
    </div>
    <div class="site-footer">
      Powered by <a href="https://github.com/getgridea/gridea" target="_blank">Gridea</a> | <a class="rss" href="https://mask0407.github.io/atom.xml" target="_blank">RSS</a>
    </div>
  </div>
</div>


      <div class="main-container">
        <div class="content-container" data-aos="fade-up">
          <div class="post-detail">
            <h2 class="post-title">SpringCloud之服务注册-Eureka</h2>
            <div class="post-date">2020-06-29</div>
            
            <div class="post-content" v-pre>
              <p>Spring Cloud Eureka 是 Spring Cloud Netflix 微服务套件中的一部分， 它基于 Netflix Eureka 做了二次封装， 主要负责完成微服务架构中的服务治理功能。 Spring Cloud 通过为Eureka 增加了 Spring Boot 风格的自动化配置，我们只需通过简单引入依赖和注解配置就能让 Spring Boot构建的微服务应用轻松地与 Eureka 服务治理体系进行整合。<br>
<img src="https://img-blog.csdnimg.cn/20200214185404109.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L00yODM1OTIzMzg=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述" loading="lazy"></p>
<h2 id="eureka单机">Eureka单机</h2>
<ul>
<li>依赖</li>
</ul>
<pre><code class="language-xml">&lt;dependency&gt;
  &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
  &lt;artifactId&gt;spring-cloud-starter-netflix-eureka-server&lt;/artifactId&gt;
&lt;/dependency&gt;
</code></pre>
<ul>
<li>applicaiton.properties</li>
</ul>
<pre><code class="language-properties">server.port=8088

eureka.instance.hostname=localhost
eureka.client.register-with-eureka=false
eureka.client.fetch-registry=false
</code></pre>
<blockquote>
<p>必须配置<code>eureka.instance.hostname</code>否则Eureka会尝试自我注册</p>
</blockquote>
<ul>
<li>EurekaSpringBootApplication</li>
</ul>
<pre><code class="language-java">@SpringBootApplication
@EnableEurekaServer
public class EurekaSpringBootApplication {
    public static void main(String[] args) {
        SpringApplication.run(EurekaSpringBootApplication.class,args);
    }
}
</code></pre>
<ul>
<li>启动项目后访问 <a href="http://localhost:8088/">http://localhost:8088/</a><br>
<img src="https://img-blog.csdnimg.cn/20200214191748549.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L00yODM1OTIzMzg=,size_16,color_FFFFFF,t_70" alt="" loading="lazy"></li>
<li>配置说明</li>
</ul>
<table>
<thead>
<tr>
<th>配置</th>
<th>说明</th>
<th>默认</th>
</tr>
</thead>
<tbody>
<tr>
<td>eureka.server.enable-self-preservation</td>
<td>Eureka自我保护机制</td>
<td>true</td>
</tr>
<tr>
<td>eureka.server.eviction-interval-timer-in-ms	Eureka</td>
<td>剔除故障节点时间间隔</td>
<td>60秒</td>
</tr>
<tr>
<td>eureka.server.renewal-percent-threshold</td>
<td>Eureka租约计算阈值</td>
<td>0.85</td>
</tr>
<tr>
<td>eureka.client.register-with-eureka</td>
<td>是否注册到Eureka上</td>
<td>true</td>
</tr>
<tr>
<td>eureka.client.fetch-registry</td>
<td>是否从Eureka上更新列表信息</td>
<td>true</td>
</tr>
<tr>
<td>eureka.instance.hostname</td>
<td>Eureka微服务实例的主机名</td>
<td>无</td>
</tr>
</tbody>
</table>
<h2 id="服务注册">服务注册</h2>
<ul>
<li>依赖</li>
</ul>
<pre><code class="language-xml">&lt;dependency&gt;
  &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
  &lt;artifactId&gt;spring-cloud-starter-netflix-eureka-client&lt;/artifactId&gt;
&lt;/dependency&gt;
</code></pre>
<ul>
<li>application.properties</li>
</ul>
<pre><code class="language-properties">spring.application.name=USER-SERVICE
eureka.instance.instance-id=001
eureka.instance.prefer-ip-address=true
eureka.instance.lease-expiration-duration-in-seconds=20
eureka.instance.lease-renewal-interval-in-seconds=10

eureka.client.register-with-eureka=true
eureka.client.healthcheck.enabled=true
eureka.client.fetch-registry=false
eureka.client.service-url.defaultZone=http://localhost:8088/eureka/
</code></pre>
<blockquote>
<p>运行项目实现服务的注册</p>
</blockquote>
<ul>
<li>注册两个服务后<br>
<img src="https://img-blog.csdnimg.cn/20200218101430947.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L00yODM1OTIzMzg=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述" loading="lazy"></li>
</ul>
<h2 id="引入依赖">引入依赖</h2>
<blockquote>
<p>Eureka中默认集成了Ribbon插件，因此只需导入<code>spring-cloud-starter-netflix-eureka-client</code>即可。</p>
</blockquote>
<ul>
<li>pom.xml</li>
</ul>
<pre><code class="language-xml">&lt;parent&gt;
  &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
  &lt;artifactId&gt;spring-boot-starter-parent&lt;/artifactId&gt;
  &lt;version&gt;2.1.5.RELEASE&lt;/version&gt;
&lt;/parent&gt;

&lt;dependencyManagement&gt;
  &lt;dependencies&gt;
    &lt;dependency&gt;
      &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
      &lt;artifactId&gt;spring-cloud-dependencies&lt;/artifactId&gt;
      &lt;version&gt;Greenwich.SR1&lt;/version&gt;
      &lt;type&gt;pom&lt;/type&gt;
      &lt;scope&gt;import&lt;/scope&gt;
    &lt;/dependency&gt;
  &lt;/dependencies&gt;
&lt;/dependencyManagement&gt;

&lt;dependencies&gt;

  &lt;dependency&gt;
    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
    &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;
  &lt;/dependency&gt;

  &lt;dependency&gt;
    &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-starter-netflix-eureka-client&lt;/artifactId&gt;
  &lt;/dependency&gt;

  &lt;dependency&gt;
    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
    &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt;
    &lt;scope&gt;test&lt;/scope&gt;
  &lt;/dependency&gt;

&lt;/dependencies&gt;
</code></pre>
<ul>
<li>application.properties</li>
</ul>
<pre><code class="language-properties">eureka.client.fetch-registry=true
eureka.client.register-with-eureka=false
eureka.client.service-url.defaultZone=http://localhost:8088/eureka/
</code></pre>
<ul>
<li>EurekaSpringBootConsumer</li>
</ul>
<pre><code class="language-java">@SpringBootApplication
public class EurekaSpringBootConsumer {
    public static void main(String[] args) {
        SpringApplication.run(EurekaSpringBootConsumer.class,args);
    }
    @Bean
    @LoadBalanced
    public RestTemplate restTemplate(){
       return new RestTemplate();
    }
}
</code></pre>
<ul>
<li>RestTemplateTests</li>
</ul>
<pre><code class="language-java">@SpringBootTest(classes = EurekaSpringBootConsumer.class)
@RunWith(SpringRunner.class)
public class RestTemplateTests {
    @Autowired
    private RestTemplate restTemplate;
    @Test
    public void testQueryUserById(){
        String url=&quot;http://USER-SERVICE/manager/user/8&quot;;
        User user = restTemplate.getForObject(url, User.class);
        System.out.println(user);
    }
}
</code></pre>
<h2 id="eureka-server安全">Eureka Server安全</h2>
<ul>
<li>新增依赖</li>
</ul>
<pre><code class="language-xml">&lt;dependency&gt;
  &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
  &lt;artifactId&gt;spring-boot-starter-security&lt;/artifactId&gt;
&lt;/dependency&gt;
</code></pre>
<ul>
<li>新增配置</li>
</ul>
<pre><code class="language-properties">spring.security.user.name=mask
spring.security.user.password=111111
</code></pre>
<ul>
<li>新增配置类 WebSecurityConfig</li>
</ul>
<pre><code class="language-java">@EnableWebSecurity
@Configuration
public class WebSecurityConfig extends WebSecurityConfigurerAdapter {

  @Override
  protected void configure(HttpSecurity http) throws Exception {
    http.csrf().disable(); // 关闭csrf,否则其他主机无法登陆认证
    http.authorizeRequests().anyRequest().authenticated().and().httpBasic();//设置成httpBasic，不可以设置为表单
  }

}
</code></pre>
<ul>
<li>服务 注册/消费 新增配置</li>
</ul>
<pre><code class="language-properties">eureka.client.service-url.defaultZone=http://mask:111111@localhost:8088/eureka/
</code></pre>
<h2 id="eureka服务端高可用配置">Eureka服务端高可用配置</h2>
<ul>
<li>application-eureka-1.properties</li>
</ul>
<pre><code class="language-properties">server.port=6666

## 指定当前注册中心的服务名称
spring.application.name=eurekaregistry

## 启用注册中心主动失效，并且每次主动失效检测间隔为5s 默认值60s
eureka.server.eviction-interval-timer-in-ms= 5000
## 设置eureka注册中心的响应更新时间
eureka.server.responseCacheUpdateIntervalMs=3000
eureka.server.responseCacheAutoExpirationInSeconds=60

## 配置注册中心的主机名
eureka.instance.instance-id = eureka-1
eureka.instance.hostname = CentOSA
## 服务刷新时间配置，每隔这个时间会主动心跳一次
eureka.instance.lease-renewal-interval-in-seconds= 5
## 服务提供者被认定为丢失心跳超时，失效多久后被删除
eureka.instance.lease-expiration-duration-in-seconds=15

## 配置定时获取|抓取注册中心的数据时间
eureka.client.registry-fetch-interval-seconds= 5
eureka.client.instance-info-replication-interval-seconds= 5
## 配置集群中其他eureka实例，用于本eureka实例的注册方。
eureka.client.region=beijing
eureka.client.availability-zones.beijing=zone-2,zone-3
eureka.client.service-url.zone-2=http://mask:111111@CentOSB:1111/eureka/
eureka.client.service-url.zone-3=http://mask:111111@CentOSC:1111/eureka/

spring.security.user.name=mask
spring.security.user.password=111111
</code></pre>
<ul>
<li>application-eureka-2.properties</li>
</ul>
<pre><code class="language-properties">server.port=6666

## 指定当前注册中心的服务名称
spring.application.name=eurekaregistry

## 启用注册中心主动失效，并且每次主动失效检测间隔为5s 默认值60s
eureka.server.eviction-interval-timer-in-ms= 5000
## 设置eureka注册中心的响应更新时间
eureka.server.responseCacheUpdateIntervalMs=3000
eureka.server.responseCacheAutoExpirationInSeconds=60

## 配置注册中心的主机名
eureka.instance.instance-id = eureka-2
eureka.instance.hostname = CentOSB
## 服务刷新时间配置，每隔这个时间会主动心跳一次
eureka.instance.lease-renewal-interval-in-seconds= 5
## 服务提供者被认定为丢失心跳超时，失效多久后被删除
eureka.instance.lease-expiration-duration-in-seconds=15

## 配置定时获取|抓取注册中心的数据时间
eureka.client.registry-fetch-interval-seconds= 5
eureka.client.instance-info-replication-interval-seconds= 5
## 配置集群中其他eureka实例，用于本eureka实例的注册方。
eureka.client.region=beijing
eureka.client.availability-zones.beijing=zone-1,zone-3
eureka.client.service-url.zone-1=http://mask:111111@CentOSA:1111/eureka/
eureka.client.service-url.zone-3=http://mask:111111@CentOSC:1111/eureka/

spring.security.user.name=mask
spring.security.user.password=111111
</code></pre>
<ul>
<li>application-eureka-3.properties</li>
</ul>
<pre><code class="language-properties">server.port=6666

## 指定当前注册中心的服务名称
spring.application.name=eurekaregistry

## 启用注册中心主动失效，并且每次主动失效检测间隔为5s 默认值60s
eureka.server.eviction-interval-timer-in-ms= 5000
## 设置eureka注册中心的响应更新时间
eureka.server.responseCacheUpdateIntervalMs=3000
eureka.server.responseCacheAutoExpirationInSeconds=60

## 配置注册中心的主机名
eureka.instance.instance-id = eureka-3
eureka.instance.hostname = CentOSC
## 服务刷新时间配置，每隔这个时间会主动心跳一次
eureka.instance.lease-renewal-interval-in-seconds= 5
## 服务提供者被认定为丢失心跳超时，失效多久后被删除
eureka.instance.lease-expiration-duration-in-seconds=15

## 配置定时获取|抓取注册中心的数据时间
eureka.client.registry-fetch-interval-seconds= 5
eureka.client.instance-info-replication-interval-seconds= 5
## 配置集群中其他eureka实例，用于本eureka实例的注册方。
eureka.client.region=beijing
eureka.client.availability-zones.beijing=zone-1,zone-2
eureka.client.service-url.zone-1=http://mask:111111@CentOSA:1111/eureka/
eureka.client.service-url.zone-2=http://mask:111111@CentOSB:1111/eureka/

spring.security.user.name=mask
spring.security.user.password=111111
</code></pre>
<ul>
<li>将三个项目打包分别上传至CentOSA、CentOSB、CentOSC运行</li>
</ul>
<blockquote>
<p>注：三台机器需关闭防火墙并互相做主机名与IP映射</p>
</blockquote>
<ul>
<li>访问<a href="http://CentOSA:6666/">http://CentOSA:6666/</a>  ---CentOSA可换为ip<br>
<img src="https://img-blog.csdnimg.cn/2020022120374450.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L00yODM1OTIzMzg=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述" loading="lazy"></li>
</ul>

            </div>
            
              <div class="tag-container">
                
                  <a href="https://mask0407.github.io/uyhs3Xoe6/" class="tag">
                    SpringCloud
                  </a>
                
                  <a href="https://mask0407.github.io/rg_9e-j4YM/" class="tag">
                    微服务
                  </a>
                
              </div>
            
            
              <div class="next-post">
                <div class="next">下一篇</div>
                <a href="https://mask0407.github.io/springcloud02/">
                  <h3 class="post-title">
                    SpringCloud之熔断器-Hystrix
                  </h3>
                </a>
              </div>
            

            

          </div>

        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.min.js"></script>
<script type="application/javascript">

AOS.init();

var app = new Vue({
  el: '#app',
  data: {
    menuVisible: false,
  },
})

</script>






  </body>
</html>
